<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Réinitialiser le mot de passe</title>

  <!-- Supabase JS v2 (UMD) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 16px;
    }
    .box {
      background: white;
      padding: 22px;
      border-radius: 10px;
      width: 360px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    h2 { margin: 0 0 14px; }
    input, button {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
    }
    button {
      border: none;
      background: #0B84F3;
      color: white;
      font-weight: 800;
      cursor: pointer;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #msg { margin-top: 12px; font-weight: 700; color: #374151; white-space: pre-wrap; }
    .muted { color: #6B7280; font-size: 13px; margin-top: 8px; }
  </style>
</head>
<body>

<div class="box">
  <h2>Nouveau mot de passe</h2>

  <input type="password" id="password" placeholder="Nouveau mot de passe" />
  <input type="password" id="password2" placeholder="Confirmer le mot de passe" />

  <button id="btn" onclick="resetPassword()">Valider</button>

  <div class="muted">
    Si rien ne marche, envoie-moi le message affiché ci-dessous.
  </div>

  <p id="msg"></p>
</div>

<script>
  // ✅ Mets ICI tes vraies valeurs
  const SUPABASE_URL = "https://bficrofdrgmuljunccsv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmaWNyb2ZkcmdtdWxqdW5jY3N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MzUxNjgsImV4cCI6MjA4MTUxMTE2OH0.xXo9uidS7dIawD7tUCA-T7255Ys14HCMkqh5cBM9Acw";

  const msgEl = document.getElementById("msg");
  const btnEl = document.getElementById("btn");

  function logMsg(text) {
    msgEl.textContent = text;
    console.log(text);
  }

  // ✅ UMD expose généralement window.supabase (pas supabaseJs)
  const supabaseLib = window.supabase;
  if (!supabaseLib || !supabaseLib.createClient) {
    logMsg("Erreur: la librairie Supabase n'est pas chargée (window.supabase introuvable).");
  }

  const client = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // --- Helpers pour récupérer la session depuis l'URL
  function parseHashTokens() {
    // ex: #access_token=...&refresh_token=...&type=recovery
    const h = window.location.hash.startsWith("#") ? window.location.hash.slice(1) : window.location.hash;
    const params = new URLSearchParams(h);
    const access_token = params.get("access_token");
    const refresh_token = params.get("refresh_token");
    const type = params.get("type");
    return { access_token, refresh_token, type };
  }

  async function ensureSessionFromUrl() {
    // 1) Mode moderne: ?code=...
    const url = new URL(window.location.href);
    const code = url.searchParams.get("code");

    if (code) {
      logMsg("Session: échange du code en cours…");
      const { data, error } = await client.auth.exchangeCodeForSession(window.location.href);
      if (error) {
        logMsg("Erreur exchangeCodeForSession:\n" + error.message);
        return false;
      }
      logMsg("Session OK (mode code).");
      return true;
    }

    // 2) Mode ancien: tokens dans le hash
    const { access_token, refresh_token, type } = parseHashTokens();
    if (access_token && refresh_token) {
      logMsg("Session: récupération via tokens…");
      const { error } = await client.auth.setSession({ access_token, refresh_token });
      if (error) {
        logMsg("Erreur setSession:\n" + error.message);
        return false;
      }
      logMsg("Session OK (mode tokens). Type=" + (type || "inconnu"));
      return true;
    }

    // 3) Sinon: on essaie de voir si une session existe déjà
    const { data } = await client.auth.getSession();
    if (data && data.session) {
      logMsg("Session déjà présente.");
      return true;
    }

    logMsg("Aucune session détectée dans l’URL.\n➡️ Ouvre ce lien depuis l’email Supabase (recovery) sur le même navigateur.");
    return false;
  }

  // Au chargement: on tente de préparer la session
  (async () => {
    btnEl.disabled = true;
    const ok = await ensureSessionFromUrl();
    btnEl.disabled = !ok;
  })();

  // --- Action bouton
  async function resetPassword() {
    try {
      const p1 = document.getElementById("password").value;
      const p2 = document.getElementById("password2").value;

      if (!p1 || p1.length < 6) {
        return logMsg("Mot de passe trop court (minimum 6 caractères).");
      }
      if (p1 !== p2) {
        return logMsg("Les deux mots de passe ne correspondent pas.");
      }

      btnEl.disabled = true;
      logMsg("Mise à jour en cours…");

      // Vérifie session
      const { data: s } = await client.auth.getSession();
      if (!s.session) {
        btnEl.disabled = false;
        return logMsg("Pas de session active.\n➡️ Re-clique sur le lien de l’email (recovery) puis réessaie.");
      }

      const { error } = await client.auth.updateUser({ password: p1 });

      if (error) {
        btnEl.disabled = false;
        return logMsg("Erreur updateUser:\n" + error.message);
      }

      logMsg("✅ Mot de passe modifié avec succès.\nTu peux fermer cette page et te reconnecter dans l’app.");
    } catch (e) {
      btnEl.disabled = false;
      logMsg("Erreur inattendue:\n" + (e?.message || String(e)));
    }
  }

  // expose pour le onclick
  window.resetPassword = resetPassword;
</script>

</body>
</html>
