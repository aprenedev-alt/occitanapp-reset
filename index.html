<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>R√©initialiser le mot de passe</title>
    <style>
      :root {
        --bg: #f4f6f8;
        --card: #ffffff;
        --text: #0b1220;
        --muted: #5b667a;
        --primary: #1677ff;
        --danger: #d92d20;
        --border: #e6e9ef;
        --radius: 16px;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        display: grid;
        place-items: center;
        min-height: 100vh;
        padding: 24px;
      }
      .wrap { width: 100%; max-width: 520px; }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 22px;
        box-shadow: 0 8px 30px rgba(16, 24, 40, 0.08);
      }
      h1 {
        margin: 0 0 14px 0;
        font-size: 26px;
        line-height: 1.15;
      }
      .sub {
        margin: 0 0 18px 0;
        color: var(--muted);
        font-size: 14px;
      }
      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin: 12px 0 6px;
      }
      input {
        width: 100%;
        padding: 14px 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 16px;
        outline: none;
        background: #fff;
      }
      input:focus { border-color: rgba(22, 119, 255, 0.5); box-shadow: 0 0 0 4px rgba(22,119,255,0.12); }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 16px;
      }
      button {
        width: 100%;
        padding: 14px 16px;
        border: 0;
        border-radius: 12px;
        background: var(--primary);
        color: #fff;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
      }
      button[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
      }
      .msg {
        margin-top: 14px;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px dashed var(--border);
        background: #fafbfc;
        color: var(--muted);
        font-size: 13px;
        white-space: pre-wrap;
        word-break: break-word;
        min-height: 44px;
      }
      .msg.error { border-color: rgba(217,45,32,0.35); color: var(--danger); background: rgba(217,45,32,0.04); }
      .msg.ok { border-color: rgba(2,122,72,0.35); color: #027a48; background: rgba(2,122,72,0.04); }
      .footer {
        margin-top: 14px;
        font-size: 12px;
        color: var(--muted);
      }
      .tiny {
        font-size: 12px;
        color: var(--muted);
        margin-top: 8px;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
      }
    </style>

    <!-- Supabase JS v2 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <h1>R√©initialiser le mot de passe</h1>
        <p class="sub">
          Ouvre cette page uniquement via le lien re√ßu par email.
        </p>

        <label for="password">Nouveau mot de passe</label>
        <input id="password" type="password" placeholder="Au moins 6 caract√®res" />

        <label for="password2">Confirmer le mot de passe</label>
        <input id="password2" type="password" placeholder="Retape le m√™me" />

        <div class="row">
          <button id="btn" onclick="resetPassword()" disabled>Valider</button>
        </div>

        <div id="msg" class="msg">Chargement‚Ä¶</div>

        <div class="footer">
          Si √ßa bloque : fais une capture du message ci-dessus.
        </div>

        <div class="tiny">
          Astuce: si tu vois <code>localhost</code> dans l‚ÄôURL, c‚Äôest que Supabase redirige mal.
        </div>
      </div>
    </div>

    <script>
      // =========================
      // 1) REMPLACE ICI
      // =========================
      const SUPABASE_URL = "https://bficrofdrgmuljunccsv.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmaWNyb2ZkcmdtdWxqdW5jY3N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MzUxNjgsImV4cCI6MjA4MTUxMTE2OH0.xXo9uidS7dIawD7tUCA-T7255Ys14HCMkqh5cBM9Acw";

      // =========================
      // 2) UI helpers
      // =========================
      const msgEl = document.getElementById("msg");
      const btnEl = document.getElementById("btn");

      function setMsg(text, type = "info") {
        msgEl.classList.remove("error", "ok");
        if (type === "error") msgEl.classList.add("error");
        if (type === "ok") msgEl.classList.add("ok");
        msgEl.textContent = text;
        console.log(text);
      }

      function mustHaveConfig() {
        if (!SUPABASE_URL || SUPABASE_URL.includes("TON_SUPABASE_URL")) {
          setMsg("‚ùå Tu n'as pas mis SUPABASE_URL.\n‚û°Ô∏è Remplace TON_SUPABASE_URL dans le code.", "error");
          return false;
        }
        if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("TON_SUPABASE_ANON_KEY")) {
          setMsg("‚ùå Tu n'as pas mis SUPABASE_ANON_KEY.\n‚û°Ô∏è Remplace TON_SUPABASE_ANON_KEY dans le code.", "error");
          return false;
        }
        return true;
      }

      // =========================
      // 3) Cr√©ation du client (AVANT tout)
      // =========================
      if (!window.supabase || !window.supabase.createClient) {
        setMsg("‚ùå Supabase JS n'est pas charg√©.\nV√©rifie l'acc√®s internet / le script CDN.", "error");
        throw new Error("Supabase JS not loaded");
      }

      if (!mustHaveConfig()) {
        // Pas la peine de continuer
      }

      const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // =========================
      // 4) Session depuis URL
      // - Supabase peut renvoyer soit:
      // a) ?code=... (PKCE)
      // b) #access_token=...&refresh_token=... (implicit)
      // =========================
      function parseHashTokens() {
        const h = window.location.hash.replace("#", "");
        const p = new URLSearchParams(h);
        return {
          access_token: p.get("access_token"),
          refresh_token: p.get("refresh_token"),
          type: p.get("type"),
          error: p.get("error"),
          error_description: p.get("error_description"),
        };
      }

      async function ensureSessionFromUrl() {
        // Si l'URL contient une erreur Supabase
        const hash = parseHashTokens();
        if (hash.error) {
          setMsg("‚ùå Erreur dans le lien Supabase:\n" + (hash.error_description || hash.error), "error");
          return false;
        }

        // Mode PKCE : ?code=...
        const url = new URL(window.location.href);
        const code = url.searchParams.get("code");

        if (code) {
          setMsg("üîÑ Validation du lien (code)‚Ä¶");
          const { error } = await client.auth.exchangeCodeForSession(window.location.href);
          if (error) {
            setMsg("‚ùå √âchec validation code:\n" + error.message, "error");
            return false;
          }
          setMsg("‚úÖ Lien valide. Tu peux changer ton mot de passe.");
          return true;
        }

        // Mode tokens dans le hash
        if (hash.access_token && hash.refresh_token) {
          setMsg("üîÑ Validation du lien (token)‚Ä¶");
          const { error } = await client.auth.setSession({
            access_token: hash.access_token,
            refresh_token: hash.refresh_token,
          });
          if (error) {
            setMsg("‚ùå √âchec validation token:\n" + error.message, "error");
            return false;
          }
          setMsg("‚úÖ Lien valide. Tu peux changer ton mot de passe.");
          return true;
        }

        // D√©j√† une session ?
        const { data, error } = await client.auth.getSession();
        if (error) {
          setMsg("‚ùå Erreur getSession:\n" + error.message, "error");
          return false;
        }
        if (data.session) {
          setMsg("‚úÖ Session d√©j√† active. Tu peux changer ton mot de passe.");
          return true;
        }

        setMsg(
          "‚ùå Aucun token d√©tect√© dans l‚ÄôURL.\n" +
            "‚û°Ô∏è Ouvre cette page UNIQUEMENT en cliquant sur le lien dans l'email Supabase.",
          "error"
        );
        return false;
      }

      // =========================
      // 5) Update password
      // =========================
      async function resetPassword() {
        try {
          const p1 = document.getElementById("password").value.trim();
          const p2 = document.getElementById("password2").value.trim();

          if (!p1 || p1.length < 6) return setMsg("‚ùå Mot de passe trop court (min 6).", "error");
          if (p1 !== p2) return setMsg("‚ùå Les mots de passe ne correspondent pas.", "error");

          btnEl.disabled = true;
          setMsg("üîÑ Mise √† jour du mot de passe‚Ä¶");

          const { data, error: sErr } = await client.auth.getSession();
          if (sErr) {
            btnEl.disabled = false;
            return setMsg("‚ùå Erreur session:\n" + sErr.message, "error");
          }
          if (!data.session) {
            btnEl.disabled = false;
            return setMsg("‚ùå Pas de session active.\n‚û°Ô∏è Clique √† nouveau sur le lien re√ßu par email.", "error");
          }

          const { error } = await client.auth.updateUser({ password: p1 });

          if (error) {
            btnEl.disabled = false;
            return setMsg("‚ùå Erreur updateUser:\n" + error.message, "error");
          }

          setMsg("‚úÖ Mot de passe modifi√© !\n‚û°Ô∏è Tu peux retourner dans l‚Äôapp et te connecter.", "ok");
        } catch (e) {
          btnEl.disabled = false;
          setMsg("‚ùå Erreur inattendue:\n" + (e?.message || String(e)), "error");
        }
      }

      window.resetPassword = resetPassword;

      // =========================
      // 6) Boot
      // =========================
      (async () => {
        try {
          btnEl.disabled = true;
          if (!mustHaveConfig()) return;
          const ok = await ensureSessionFromUrl();
          btnEl.disabled = !ok;
        } catch (e) {
          btnEl.disabled = false;
          setMsg("‚ùå Erreur boot:\n" + (e?.message || String(e)), "error");
        }
      })();
    </script>
  </body>
</html>
